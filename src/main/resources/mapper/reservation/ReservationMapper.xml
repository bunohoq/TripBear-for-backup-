<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.project.trip.reservation.mapper.ReservationMapper">

    <!-- 통합예약 INSERT: reservationId를 selectKey로 미리 뽑아 DTO에 주입 -->
    <insert id="insertReservation" parameterType="com.project.trip.reservation.model.ReservationDTO">
        <selectKey keyProperty="reservationId" resultType="long" order="BEFORE">
            SELECT seqReservation.NEXTVAL FROM dual
        </selectKey>

        INSERT INTO tblReservation (
            reservation_id,
            user_id,
            user_route_id,
            status_id,
            reservation_price,
            reservation_start_date,
            reservation_end_date
            -- reservation_regdate는 DEFAULT SYSDATE 사용
        ) VALUES (
            #{reservationId},
            #{userId},
            #{userRouteId},
            NVL(#{statusId}, 1),  <!-- 기본값: 예약요청(1) -->
            #{reservationPrice},
            TO_DATE(#{reservationStartDate}, 'YYYY-MM-DD'),
            TO_DATE(#{reservationEndDate},   'YYYY-MM-DD')
        )
    </insert>

    <!-- 객실예약 INSERT (필수) -->
    <insert id="insertAccomReservation" parameterType="com.project.trip.reservation.dto.AccomReservationDTO">
        <selectKey keyProperty="accomReservationId" resultType="long" order="BEFORE">
            SELECT seqAccomReservation.NEXTVAL FROM dual
        </selectKey>

        INSERT INTO tblAccomReservation (
            accom_reservation_id,
            room_id,
            reservation_id,
            user_route_id,
            status_id,
            guest_count,
            room_total_price,
            checkin_date,
            checkout_date,
            accom_notes
        ) VALUES (
            #{accomReservationId},
            #{roomId},
            #{reservationId},        <!-- 통합예약 PK FK -->
            #{userRouteId},
            #{statusId},
            #{guestCount},
            #{roomTotalPrice},
            TO_DATE(#{checkinDate},  'YYYY-MM-DD'),
            TO_DATE(#{checkoutDate}, 'YYYY-MM-DD'),
            #{accomNotes}
        )
    </insert>

    <!-- 차량예약 INSERT (선택) -->
    <insert id="insertCarReservation" parameterType="com.trip.reservation.dto.CarReservationDTO">
        <selectKey keyProperty="carReservationId" resultType="long" order="BEFORE">
            SELECT seqCarReservation.NEXTVAL FROM dual
        </selectKey>

        INSERT INTO tblCarReservation (
            car_reservation_id,
            car_id,
            reservation_id,
            user_route_id,
            status_id,
            pickup_date,
            dropoff_date,
            pickup_location,
            dropoff_location,
            car_total_price,
            car_notes
        ) VALUES (
            #{carReservationId},
            #{carId},
            #{reservationId},        <!-- 통합예약 PK FK -->
            #{userRouteId},
            #{statusId},
            TO_DATE(#{pickupDate},   'YYYY-MM-DD'),
            TO_DATE(#{dropoffDate},  'YYYY-MM-DD'),
            #{pickupLocation},
            #{dropoffLocation},
            #{carTotalPrice},
            #{carNotes}
        )
    </insert>

</mapper>
